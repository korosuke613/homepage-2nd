name: Claude review PR
run-name: "#${{ github.event.number || github.event.inputs.pr_number }} | Claude review PR"

on:
  pull_request:
    types: [opened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'レビューするPR番号'
        required: true
        type: number

jobs:
  review:
    if: ${{ github.actor == 'kiba-renovate[bot]' || github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: claude-code-action
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: "blob:none"
          ref: ${{ github.event.pull_request.head.sha || format('refs/pull/{0}/head', github.event.inputs.pr_number) }}

      - name: Login GitHub App
        id: login-gh-app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.KIBA_CLAUDE_CODE_GH_APP_ID }}
          private-key: ${{ secrets.KIBA_CLAUDE_CODE_GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name || github.repository }}
          permission-contents: read
          permission-pull-requests: write
          permission-actions: read
          permission-issues: read

      - name: Get Github App permissions
        id: get-gh-app-permissions
        env:
          GH_TOKEN: ${{ steps.login-gh-app.outputs.token }}
        run: |
          gh api /apps/${{ steps.login-gh-app.outputs.app-slug }} | tee ${{ runner.temp }}/gh-app-permissions.json
          echo "permissions=$(jq -c '.permissions' ${{ runner.temp }}/gh-app-permissions.json)" >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@777ffcbfc9d2e2b07f3cfec41b7c7eadedd1f0dc # v1.0.12
        env:
          GH_TOKEN: ${{ steps.login-gh-app.outputs.token }}
          GH_APP_PERMISSIONS: ${{ steps.get-gh-app-permissions.outputs.permissions }}
        with:
          github_token: ${{ steps.login-gh-app.outputs.token }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}

            このプルリクエストを以下の点に重点を置いてレビューしてください：
            - コード品質とベストプラクティス
            - 潜在的なバグや問題
            - セキュリティへの影響
            - パフォーマンスに関する考慮事項
            注：PRブランチは既に現在の作業ディレクトリでチェックアウトされています。
            トップレベルのフィードバックには `gh pr comment` を使用してください。
            特定のコードの問題を強調するには `mcp__github_inline_comment__create_inline_comment` を使用してください。
            GitHubコメントのみを投稿してください - レビューテキストをメッセージとして送信しないでください。

          claude_args: |
            --allowedTools "WebFetch,WebSearch,mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
            --system-prompt "あなたは GitHub Actions 上で動作する Claude Code Action です。あなたは GitHub App の権限を持ちます。付与されている権限は ${{ env.GH_APP_PERMISSIONS }} です"
