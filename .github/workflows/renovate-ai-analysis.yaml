name: Renovate AI Analysis

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  ai-analysis:
    permissions:
      contents: read
      pull-requests: write
      models: read

    if: startsWith(github.head_ref, 'renovate/') && github.actor == 'kiba-renovate[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: blob:none

      - name: Get PR details
        id: pr-details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Get PR information
          PR_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body')
          
          # Get changed files
          CHANGED_FILES=$(gh pr diff $PR_NUMBER --name-only)

          # Get package.json changes if any
          PACKAGE_CHANGES=""
          if echo "$CHANGED_FILES" | grep -q "package.json\|package-lock.json"; then
            PACKAGE_CHANGES=$(gh pr diff $PR_NUMBER -- package.json package-lock.json || echo "No package changes visible")
          fi
          
          # Save to files for AI analysis
          echo "$PR_TITLE" > $GITHUB_WORKSPACE/pr-title.txt
          echo "$PR_BODY" > $GITHUB_WORKSPACE/pr-body.txt
          echo "$CHANGED_FILES" > $GITHUB_WORKSPACE/changed-files.txt
          echo "$PACKAGE_CHANGES" > $GITHUB_WORKSPACE/package-changes.txt
          
          # Determine update type and severity
          if [[ "$PR_TITLE" =~ \bmajor\b ]]; then
            echo "update-type=major" >> $GITHUB_OUTPUT
            echo "severity=high" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" =~ minor ]]; then
            echo "update-type=minor" >> $GITHUB_OUTPUT
            echo "severity=medium" >> $GITHUB_OUTPUT
          else
            echo "update-type=patch" >> $GITHUB_OUTPUT
            echo "severity=low" >> $GITHUB_OUTPUT
          fi

      - name: AI Analysis of Changes
        id: ai-analysis
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o
          prompt: |
            You are a senior software engineer reviewing a dependency update PR created by Renovate.
            
            Analyze the following PR details and provide a concise summary:
            
            **PR Title:** $(cat /tmp/pr-title.txt)
            
            **PR Description:** $(cat /tmp/pr-body.txt)
            
            **Changed Files:** $(cat /tmp/changed-files.txt)
            
            **Package Changes:** $(cat /tmp/package-changes.txt)
            
            **Update Type:** ${{ steps.pr-details.outputs.update-type }}
            
            Please provide:
            1. A brief summary of what packages are being updated
            2. Potential impact and risks (especially for major updates)
            3. Recommended actions before merging
            4. Any security considerations
            
            Keep the response concise and actionable. Format as markdown.

      - name: Comment AI Analysis
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AI_ANALYSIS="${{ steps.ai-analysis.outputs.response }}"
          
          # Create comment with AI analysis
          cat > /tmp/ai-comment.md << 'EOF'
          ## ðŸ¤– AI Analysis Summary
          
          $AI_ANALYSIS
          
          ---
          *Generated by GitHub Models AI*
          EOF
          
          # Substitute environment variables in the comment
          envsubst < /tmp/ai-comment.md > /tmp/ai-comment-final.md
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file /tmp/ai-comment-final.md \
            --repo ${{ github.repository }}

      - uses: Kesin11/actions-timeline@3046833d9aacfd7745c5264b7f3af851c3e2a619 # v2.2.1
