# Renovate AI 分析ワークフロー
#
# このワークフローは、Renovateの依存関係更新PRに対してAIを活用した自動分析を提供します。
# 開発者がマージ前に依存関係更新の影響とリスクを理解するのに役立ちます。
#
# 責務:
# - RenovateのPRが開かれた、または更新された際に自動で分析を実行
# - PR情報（変更内容、プロジェクトタイプ、依存関係）を抽出
# - GitHub Models AIを使用して以下の項目を含む構造化された分析を提供:
#   * 更新されるパッケージの概要
#   * 潜在的な影響とリスクの評価
#   * マージ前の推奨アクション
#   * セキュリティ考慮事項
# - 構造化されたマークダウンテンプレートでPRコメントに分析結果を投稿
# - PRが変更された際は既存の分析を更新して重複コメントを防止
# - デバッグと監視のための包括的なログを提供
#
# トリガー:
# - kiba-renovate[bot]によって作成されたmainブランチ対象のPRでのみ実行
# - PRのopenとsynchronizeイベントで起動
#
# セキュリティ:
# - 安全な一時ファイル処理にrunner.tempを使用
# - ハング防止のための適切なタイムアウト制御を実装
# - 最小権限の原則に従った権限モデル
#
# 依存関係:
# - GitHub CLI (gh) - PR操作用
# - GitHub Models AI - 分析生成用
# - jq - Node.jsプロジェクトでのJSON処理用

name: Renovate AI Analysis

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string

jobs:
  ai-analysis:
    permissions:
      contents: read
      pull-requests: write
      models: read

    if: (github.event_name == 'pull_request' && startsWith(github.head_ref, 'renovate/') && github.actor == 'kiba-renovate[bot]') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: blob:none

      - name: Collect PR Details
        id: pr-details
        timeout-minutes: 2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
          PR_TITLE: ${{ github.event.pull_request.title || '' }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          .github/workflows/bin/renovate-ai-analysis/collect-pr-details.sh

      - name: AI Analysis of Changes
        id: ai-analysis
        timeout-minutes: 5
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o
          prompt: |
            You are a senior software engineer reviewing a dependency update PR created by Renovate.
            
            Analyze the following PR details and provide a structured response:
            
            **PR Title:** $(cat ${{ steps.pr-details.outputs.TEMP_DIR }}/pr-title.txt)
            
            **PR Description:** $(cat ${{ steps.pr-details.outputs.TEMP_DIR }}/pr-body.txt)
            
            **Changed Files:** $(cat ${{ steps.pr-details.outputs.TEMP_DIR }}/changed-files.txt)
            
            **Main Dependencies:** $(cat ${{ steps.pr-details.outputs.TEMP_DIR }}/main-dependencies.txt)
            
            **Project Context:** $(cat ${{ steps.pr-details.outputs.TEMP_DIR }}/readme-context.txt)
            
            **Update Type:** $(cat ${{ steps.pr-details.outputs.TEMP_DIR }}/update-type.txt)
            
            Please provide your analysis in the following structured format (use plain text without markdown formatting):
            
            SUMMARY: [Brief summary of what packages are being updated]
            IMPACT: [Potential impact and risks, especially for major updates]
            ACTIONS: [Recommended actions before merging]
            SECURITY: [Any security considerations]
            
            Keep each section concise and actionable. Use plain text only without any markdown formatting.

      - name: Process AI Analysis
        timeout-minutes: 2
        env:
          AI_RESPONSE_INPUT: ${{ steps.ai-analysis.outputs.response }}
        run: |
          .github/workflows/bin/renovate-ai-analysis/analyze-with-ai.sh "${{ steps.pr-details.outputs.TEMP_DIR }}"

      - name: Generate Comment
        timeout-minutes: 1
        run: |
          .github/workflows/bin/renovate-ai-analysis/generate-comment.sh "${{ steps.pr-details.outputs.TEMP_DIR }}"

      - name: Post Comment
        timeout-minutes: 2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          .github/workflows/bin/renovate-ai-analysis/post-comment.sh "${{ steps.pr-details.outputs.TEMP_DIR }}"

      - uses: Kesin11/actions-timeline@3046833d9aacfd7745c5264b7f3af851c3e2a619 # v2.2.1
