# Squid configuration for VS Code development environment
# Provides precise domain-based filtering with wildcard support

# Basic Squid settings
http_port 3128
# Disable transparent proxy mode for HTTPS to avoid SSL issues
# http_port 3129 intercept
cache deny all
access_log /var/log/squid/access.log squid

# Standard ACL definitions
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl Safe_ports port 8080
acl Safe_ports port 1025-65535
acl CONNECT method CONNECT
acl localhost src 127.0.0.1/32 ::1
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# Container network access (allow proxy usage from container)
acl container_clients src 172.16.0.0/12
acl container_clients src 192.168.0.0/16

# VS Code and Microsoft services (wildcard domains)
acl vscode_domains dstdomain .visualstudio.com
acl vscode_domains dstdomain .microsoft.com
acl vscode_domains dstdomain .microsoftonline.com
acl vscode_domains dstdomain .live.com
acl vscode_domains dstdomain .windows.net
acl vscode_domains dstdomain .trafficmanager.net
acl vscode_domains dstdomain .vsassets.io
acl vscode_domains dstdomain .gallerycdn.vsassets.io
acl vscode_domains dstdomain .gallery.vsassets.io
acl vscode_domains dstdomain .vscode-cdn.net
acl vscode_domains dstdomain .vscode-unpkg.net
acl vscode_domains dstdomain .azure.com
acl vscode_domains dstdomain .azureedge.net
acl vscode_domains dstdomain .azurewebsites.net

# GitHub domains (wildcard)
acl github_domains dstdomain .github.com
acl github_domains dstdomain .githubusercontent.com
acl github_domains dstdomain .githubassets.com
acl github_domains dstdomain .githubstatus.com

# Development and package manager domains (wildcard)
acl dev_domains dstdomain .npmjs.org
acl dev_domains dstdomain .anthropic.com
acl dev_domains dstdomain .sentry.io
acl dev_domains dstdomain .statsig.com

# CDN and infrastructure domains (wildcard)
acl cdn_domains dstdomain .akamai.net
acl cdn_domains dstdomain .akamaitechnologies.com
acl cdn_domains dstdomain .edgesuite.net
acl cdn_domains dstdomain .cloudfront.net
acl cdn_domains dstdomain .fastly.com

# Specific exact domains
acl exact_domains dstdomain code.visualstudio.com
acl exact_domains dstdomain update.code.visualstudio.com
acl exact_domains dstdomain vscode.dev
acl exact_domains dstdomain go.microsoft.com
acl exact_domains dstdomain default.exp-tas.com
acl exact_domains dstdomain rink.hockeyapp.net
acl exact_domains dstdomain bingsettingssearch.trafficmanager.net
acl exact_domains dstdomain vscode.search.windows.net
acl exact_domains dstdomain vsmarketplacebadges.dev
acl exact_domains dstdomain vscode.download.prss.microsoft.com
acl exact_domains dstdomain download.visualstudio.microsoft.com
acl exact_domains dstdomain vscode-sync.trafficmanager.net
acl exact_domains dstdomain vscode-sync-insiders.trafficmanager.net

# DNS servers
acl dns_servers dstdomain 8.8.8.8
acl dns_servers dstdomain 8.8.4.4
acl dns_servers dstdomain 1.1.1.1
acl dns_servers dstdomain 1.0.0.1

# Access rules (order matters!)
# Deny unsafe ports and methods first
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localhost for management
http_access allow localhost

# Allow container clients to access specific allowed domains only
http_access allow container_clients vscode_domains
http_access allow container_clients exact_domains
http_access allow container_clients github_domains
http_access allow container_clients dev_domains
http_access allow container_clients cdn_domains
http_access allow CONNECT SSL_ports container_clients vscode_domains
http_access allow CONNECT SSL_ports container_clients exact_domains
http_access allow CONNECT SSL_ports container_clients github_domains
http_access allow CONNECT SSL_ports container_clients dev_domains
http_access allow CONNECT SSL_ports container_clients cdn_domains

# Allow DNS queries
http_access allow dns_servers

# Deny all other requests
http_access deny all

# Disable caching to avoid issues with dynamic content
cache deny all

# Error page customization
error_directory /usr/share/squid/errors/English

# Logging configuration
logfile_rotate 10
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
netdb_filename stdio:/var/log/squid/netdb.state

# Performance tuning for development environment
workers 1
cpu_affinity_map process_numbers=1 cores=1

# Memory settings
cache_mem 64 MB
maximum_object_size_in_memory 1 MB

# DNS settings
dns_nameservers 8.8.8.8 8.8.4.4 1.1.1.1

# Disable unnecessary features
coredump_dir /var/spool/squid
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320